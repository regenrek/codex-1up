#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

install_prompt_templates() {
  local src_dir="${ROOT_DIR}/templates/prompts"
  local dest_dir="${HOME}/.codex/prompts"

  if [ ! -d "$src_dir" ]; then
    echo "Prompt templates directory not found: ${src_dir}" >&2
    return 1
  fi

  mkdir -p "$dest_dir"

  local installed=0
  local skipped=0
  for src in "$src_dir"/*.md; do
    [ -e "$src" ] || continue
    local dest="${dest_dir}/$(basename "$src")"
    if [ -f "$dest" ]; then
      echo "Keeping existing prompt: ${dest}"
      skipped=1
      continue
    fi
    cp "$src" "$dest"
    echo "Installed prompt template: ${dest}"
    installed=1
  done

  if [ "$installed" -eq 0 ]; then
    if [ "$skipped" -eq 0 ]; then
      echo "No prompt templates found to install."
    else
      echo "All prompt templates already present in ${dest_dir}."
    fi
  fi
}

maybe_install_prompt_templates() {
  local dest_dir="${HOME}/.codex/prompts"
  printf "Install prompt templates to %s? Existing files will be kept. [y/N] " "$dest_dir"
  local ans
  if ! read -r ans; then ans="n"; fi
  if [[ "$ans" =~ ^[Yy]$ ]]; then
    install_prompt_templates
  else
    echo "Skipping prompt template installation."
  fi
}

usage() {
  cat <<USAGE
codex-1up â€” wrapper

Usage:
  codex-1up install [install.sh args]
  codex-1up agents --path <repo-path> [--template default|typescript|python|shell]
  codex-1up doctor
  codex-1up uninstall

Examples:
  codex-1up install --yes --skip-confirmation --vscode openai.codex --git-external-diff
  codex-1up agents --path $PWD --template default
USAGE
}

cmd="${1:-}"; shift || true
case "$cmd" in
  install)
    exec "${ROOT_DIR}/install.sh" "$@"
    ;;
  agents)
    # convenience: write AGENTS.md to a path
    target=""
    template="default"
    while [ $# -gt 0 ]; do
      case "$1" in
        --path) target="${2:-}"; shift ;;
        --template) template="${2:-default}"; SET_BY_FLAG=1; shift ;;
        *) ;;
      esac
      shift
    done
    if [ -z "$target" ]; then
      echo "Provide --path <repo>"
      exit 1
    fi
    if [ -d "$target" ]; then
      path="$target/AGENTS.md"
    else
      path="$target"
    fi
    # If no explicit template flag provided, offer interactive selection
    if [ "$template" = "default" ] && [ -z "${SET_BY_FLAG:-}" ]; then
      echo "Select AGENTS.md template:"
      echo "  1) default"
      echo "  2) typescript"
      echo "  3) python"
      echo "  4) shell"
      echo -n "Choose [1-4] (default: 1): "
      read -r choice || choice="1"
      case "$choice" in
        1|"default"|"DEFAULT"|"") template="default" ;;
        2|"typescript"|"TYPESCRIPT") template="typescript" ;;
        3|"python"|"PYTHON") template="python" ;;
        4|"shell"|"SHELL") template="shell" ;;
        *) echo "Invalid choice, using default"; template="default" ;;
      esac
    fi

    src="${ROOT_DIR}/templates/agent-templates/AGENTS-${template}.md"
    if [ ! -f "$src" ]; then
      echo "Unknown template: ${template}"
      echo "Available: default, typescript, python, shell"
      exit 1
    fi

    # Overwrite prompt with backup if file exists
    if [ -f "$path" ]; then
      echo "${path} already exists"
      read -r -p "Overwrite it? (backup will be created) [y/N] " ans || ans="n"
      if [[ ! "$ans" =~ ^[Yy]$ ]]; then
        echo "Keeping existing AGENTS.md unchanged"
        exit 0
      fi
      backup="${path}.backup.$(date +%Y%m%d_%H%M%S)"
      cp "$path" "$backup"
      echo "Backed up existing AGENTS.md to: ${backup}"
    fi

    cp -f "$src" "$path"
    maybe_install_prompt_templates
    echo "Wrote ${path} (template: ${template})"
    ;;
  doctor)
    exec "${ROOT_DIR}/scripts/doctor.sh"
    ;;
  uninstall)
    exec "${ROOT_DIR}/scripts/uninstall.sh"
    ;;
  *)
    usage; exit 1 ;;
esac
